```{r message=FALSE, warning=FALSE}
library(dplyr)
library(readxl)
library(ggplot2)
library(lubridate)
```



```{r}
gdrive_path <- paste(LETTERS[file.exists(paste0(LETTERS, ":/My Drive"))],":/My Drive",sep = "")
project_path <- file.path(gdrive_path,"Academic_git/DownScaling")
generalData_path <- file.path(gdrive_path,"General_Data")
```





```{r}
library(dplyr)
library(lubridate)

# --- 1 & 2. READ THE DATA AND DATES ---
file_path <- file.path(generalData_path,"EL08/volos_NOA_.txt")
df <- read.table(file_path, skip = 16, col.names = "precip")

# Clean NAs
df$precip[df$precip == -999] <- NA

# Extract dates dynamically from header
header_lines <- readLines(file_path, n = 16)
start_line <- grep("^Start datetime:", header_lines, value = TRUE)
start_date_str <- sub("Start datetime: ", "", start_line)
end_line <- grep("^End datetime:", header_lines, value = TRUE)
end_date_str <- sub("End datetime: ", "", end_line)

start_ts <- ymd(start_date_str)
end_ts <- ymd(end_date_str)
df$date <- seq(start_ts, end_ts, by = "day")

# --- 3. CONVERT TO AVERAGED PROCESS ---
intervals_per_day <- 96
df$precip_rate <- df$precip / intervals_per_day

# --- 4. CALCULATE VARIANCES ACROSS MULTIPLE SCALES ---
aggregation_days <- c(1:10)
empirical_k <- aggregation_days * intervals_per_day 
empirical_var <- numeric(length(aggregation_days))

for (i in seq_along(aggregation_days)) {
  agg_length <- aggregation_days[i]
  
  df_aggregated <- df %>%
    mutate(
      cal_year = year(date),
      bin_in_year = (yday(date) - 1) %/% agg_length
    ) %>%
    group_by(cal_year, bin_in_year) %>%
    summarise(
      days_in_bin = n(),
      mean_precip = mean(precip_rate, na.rm = FALSE),
      .groups = "drop"
    ) %>%
    filter(!is.na(mean_precip) & days_in_bin == agg_length)
  
  empirical_var[i] <- var(df_aggregated$mean_precip, na.rm = TRUE)
}

# --- 5. DEFINE CLIMACOGRAM MODELS ---

# Model 1: Hurst-Kolmogorov (HK) process
climacogram_HK <- function(k, params) {
  lambda <- params[1]; alpha <- params[2]; H <- params[3]
  lambda * (alpha / k)^(2 - 2*H)
}

# Model 2: Hybrid Hurst-Kolmogorov (HHK) process
climacogram_HHK <- function(k, params) {
  lambda <- params[1]; alpha <- params[2]; H <- params[3]; M <- params[4]
  lambda * (1 + (k / alpha)^(2*M))^((H - 1) / M)
}


# --- 6. EXPLICIT OBJECTIVE FUNCTIONS  ---

# Objective function specific to the HK model
objective_HK <- function(params) {
  # Calculate Theoretical Variances
  modeled_var <- climacogram_HK(empirical_k, params)
  
  # Minimize relative error between empirical and theoretical
  sum( ((empirical_var - modeled_var) / empirical_var)^2, na.rm = TRUE )
}

# Objective function specific to the HHK model
objective_HHK <- function(params) {
  # Calculate Theoretical Variances
  modeled_var <- climacogram_HHK(empirical_k, params)
  
  # Minimize relative error between empirical and theoretical
  sum( ((empirical_var - modeled_var) / empirical_var)^2, na.rm = TRUE )
}


# --- 7. RUN OPTIMIZATION --- 
guess_lambda <- 3

# Fit Model 1: HK process
init_HK <- c(lambda = guess_lambda, alpha = 10, H = 0.5)
low_HK  <- c(lambda = 1e-6, alpha = 1e-3, H = 1e-3)
up_HK   <- c(lambda = Inf,  alpha = 1000, H = 1.0-1e-3)

fit_HK <- optim(par = init_HK, fn = objective_HK,
                method = "L-BFGS-B", lower = low_HK, upper = up_HK, 
                control = list(maxit=5000)) 

# Fit Model 2: HHK process
init_HHK <- c(lambda = guess_lambda, alpha = 10, H = 0.5, M = 0.25)
low_HHK  <- c(lambda = 1e-6, alpha = 1e-3, H = 1e-3, M = 1e-3)
up_HHK   <- c(lambda = Inf,  alpha = 1000, H = 1.0-1e-3,  M = 1.0-1e-3)

fit_HHK <- optim(par = init_HHK, fn = objective_HHK,
                 method = "L-BFGS-B", lower = low_HHK, upper = up_HHK, 
                 control = list(maxit=5000)) 


# --- 8. EXTRAPOLATE TO 15-MIN VARIANCE (k = 1) ---
var_15min_HK <- climacogram_HK(1, fit_HK$par)
cat(sprintf("[1] Hurst-Kolmogorov (HK) process     -> 15-min Var: %.4f \n", var_15min_HK))

var_15min_HHK <- climacogram_HHK(1, fit_HHK$par)
cat(sprintf("[2] Hybrid Hurst-Kolmogorov (HHK) process -> 15-min Var: %.4f \n", var_15min_HHK))



```



```{r}



library(ggplot2)

# --- 1. PREPARE THE DATA FOR PLOTTING ---
# Empirical data points (from your aggregated coarse scales)
df_empirical <- data.frame(
  k = empirical_k,
  variance = empirical_var
)

# Generate a continuous sequence of k values (from 15-min up to your max empirical scale)
k_seq <- exp(seq(log(1), log(max(empirical_k)), length.out = 200))

# Create a combined dataframe for the 2 fitted model lines
df_lines <- rbind(
  data.frame(k = k_seq, 
             variance = climacogram_HK(k_seq, fit_HK$par), 
             Model = "1. Hurst-Kolmogorov (HK) process"),
  data.frame(k = k_seq, 
             variance = climacogram_HHK(k_seq, fit_HHK$par), 
             Model = "2. Hybrid Hurst-Kolmogorov (HHK) process")
) 

# Create a dataframe for the 2 downscaled points at k = 1 (15-min scale)
df_downscaled <- data.frame(
  k = c(1, 1),
  variance = c(var_15min_HK, var_15min_HHK),
  Model = c("1. Hurst-Kolmogorov (HK) process", "2. Hybrid Hurst-Kolmogorov (HHK) process")
)

# --- 2. CREATE THE LOG-LOG COMPARISON PLOT ---
ggplot() +
  geom_line(data = df_lines, aes(x = k, y = variance, color = Model, linetype = Model), linewidth = 1) +
  geom_point(data = df_downscaled, aes(x = k, y = variance, color = Model), size = 5, shape = 18) +
  geom_point(data = df_empirical, aes(x = k, y = variance), color = "black", size = 3) +
  
  # FIX: Make sure BOTH axes are logarithmic
  scale_x_log10(breaks = c(1, 96, 96*10, 96*30),
                labels = c("15-min\n(k=1)", "1 Day\n(k=96)", "10 Days", "30 Days")) +
  
  scale_color_brewer(palette = "Set1") +
  labs(
    title = "Comparison of 15-min Variance Downscaling",
    subtitle = "Evaluating HK and HHK climacogram models",
    x = "Scale k (number of 15-min intervals)",
    y = "Variance (Log Scale)",
    color = "Fitted Models",
    linetype = "Fitted Models"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )
```






